<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ControlCobros - App de Gestión de Préstamos</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Leaflet para mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    

    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #34a853;
            --danger-color: #ea4335;
            --warning-color: #fbbc05;
            --light-color: #f8f9fa;
            --dark-color: #202124;
            --sidebar-width: 280px;
            --header-height: 60px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            overflow-x: hidden;
        }
        
        /* Estilos de autenticación */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a73e8, #34a853);
            padding: 20px;
        }
        
        .auth-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            width: 100%;
            max-width: 400px;
            padding: 30px;
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-header h1 {
            color: var(--primary-color);
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .auth-header p {
            color: #666;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
        }
        
        .btn:hover {
            background: #1765cc;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .auth-options {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .auth-options a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
        }
        
        .auth-options a:hover {
            text-decoration: underline;
        }
        
        .role-selector {
            display: flex;
            margin-bottom: 20px;
            background: #f1f3f4;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .role-option {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .role-option.active {
            background: var(--primary-color);
            color: white;
        }
        
        /* Estilos de la aplicación principal */
        .app-container {
            display: none;
            min-height: 100vh;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--dark-color);
            color: white;
            overflow-y: auto;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-logo i {
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .sidebar-logo h2 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .close-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .user-profile {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .user-info h3 {
            font-size: 16px;
            margin-bottom: 3px;
        }
        
        .user-info p {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-item {
            margin-bottom: 5px;
        }
        
        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .menu-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .menu-link.active {
            background: var(--primary-color);
            color: white;
        }
        
        .menu-link i {
            width: 24px;
            margin-right: 10px;
            font-size: 18px;
        }
        
        .menu-text {
            flex: 1;
        }
        
        .menu-badge {
            background: var(--danger-color);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .submenu.open {
            max-height: 500px;
        }
        
        .submenu .menu-link {
            padding-left: 54px;
            font-size: 14px;
        }
        
        .main-content {
            margin-left: 0;
            padding-top: var(--header-height);
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.sidebar-open {
            margin-left: var(--sidebar-width);
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 999;
        }
        
        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .header-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .content {
            padding: 20px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
        }
        
        .stat-icon.primary {
            background: rgba(26, 115, 232, 0.1);
            color: var(--primary-color);
        }
        
        .stat-icon.success {
            background: rgba(52, 168, 83, 0.1);
            color: var(--secondary-color);
        }
        
        .stat-icon.warning {
            background: rgba(251, 188, 5, 0.1);
            color: var(--warning-color);
        }
        
        .stat-icon.danger {
            background: rgba(234, 67, 53, 0.1);
            color: var(--danger-color);
        }
        
        .stat-info h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--dark-color);
        }
        
        .stat-info p {
            font-size: 14px;
            color: #666;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-success {
            background: var(--secondary-color);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 1px solid #eee;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.active {
            background: rgba(52, 168, 83, 0.1);
            color: var(--secondary-color);
        }
        
        .status-badge.inactive {
            background: rgba(234, 67, 53, 0.1);
            color: var(--danger-color);
        }
        
        .status-badge.pending {
            background: rgba(251, 188, 5, 0.1);
            color: var(--warning-color);
        }
        
        .status-badge.overdue {
            background: rgba(234, 67, 53, 0.1);
            color: var(--danger-color);
        }
        
        .status-badge.paid {
            background: rgba(52, 168, 83, 0.1);
            color: var(--secondary-color);
        }
        
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        
        .map-container {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.open {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-state i {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 15px;
        }
        
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #666;
        }
        
        .empty-state p {
            color: #999;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }
        
        .bottom-nav-items {
            display: flex;
        }
        
        .bottom-nav-item {
            flex: 1;
            padding: 10px;
            text-align: center;
            color: #666;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .bottom-nav-item.active {
            color: var(--primary-color);
        }
        
        .bottom-nav-item i {
            display: block;
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .bottom-nav-item span {
            display: block;
            font-size: 12px;
        }
        
        .floating-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 24px;
            cursor: pointer;
            z-index: 998;
            display: none;
        }
        
        .client-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        
        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .client-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .client-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .client-detail {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .client-actions {
            display: flex;
            gap: 10px;
        }
        
        .credit-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        
        .credit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .credit-amount {
            font-weight: 600;
            font-size: 18px;
        }
        
        .credit-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .credit-detail {
            text-align: center;
        }
        
        .credit-detail-label {
            font-size: 12px;
            color: #666;
        }
        
        .credit-detail-value {
            font-size: 14px;
            font-weight: 500;
        }
        
        .payment-progress {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .payment-progress-bar {
            height: 100%;
            background: var(--secondary-color);
        }
        
        .payment-actions {
            display: flex;
            gap: 10px;
        }
        
        .whatsapp-btn {
            background: #25d366;
            color: white;
        }
        
        .location-btn {
            background: #4285f4;
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 300px;
            }
            
            .main-content.sidebar-open {
                margin-left: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .bottom-nav {
                display: block;
            }
            
            .floating-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .content {
                padding-bottom: 80px;
            }
        }
        
        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Alertas */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: rgba(52, 168, 83, 0.1);
            color: var(--secondary-color);
            border-left: 4px solid var(--secondary-color);
        }
        
        .alert-danger {
            background: rgba(234, 67, 53, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }
        
        .alert-warning {
            background: rgba(251, 188, 5, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }
        
        .alert-info {
            background: rgba(26, 115, 232, 0.1);
            color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
        }
        
        /* Notificaciones */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            max-width: 350px;
        }
        
        .notification {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification-icon {
            margin-right: 15px;
            font-size: 20px;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .notification-message {
            font-size: 14px;
            color: #666;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- Pantalla de autenticación -->
    <div class="auth-container" id="authContainer">
        <div class="auth-card">
            <div class="auth-header">
                <h1>ControlCobros</h1>
                <p>Gestión de Préstamos y Cobros</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Correo electrónico</label>
                    <input type="email" id="email" class="form-control" placeholder="correo@ejemplo.com" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" class="form-control" placeholder="Contraseña" required>
                </div>
                
                <button type="submit" class="btn btn-block">Iniciar Sesión</button>
            </form>
            
            <div class="auth-options">
                <a href="#" id="forgotPassword">¿Olvidaste tu contraseña?</a>
                <a href="#" id="createAccount">Crear cuenta</a>
            </div>
        </div>
    </div>
    
    <!-- Aplicación principal -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-coins"></i>
                    <h2>ControlCobros</h2>
                </div>
                <button class="close-sidebar" id="closeSidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-info">
                    <h3 id="userName">Usuario</h3>
                    <p id="userRole">Rol</p>
                </div>
            </div>
            
            <div class="sidebar-menu" id="sidebarMenu">
                <!-- Menú para administrador -->
                <div id="adminMenu">
                    <div class="menu-item">
                        <a href="#" class="menu-link active" data-page="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span class="menu-text">Dashboard</span>
                        </a>
                    </div>
                    
                    <div class="menu-item">
                        <a href="#" class="menu-link" id="collectorsMenuToggle">
                            <i class="fas fa-users"></i>
                            <span class="menu-text">Cobradores</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="submenu" id="collectorsSubmenu">
                            <a href="#" class="menu-link" data-page="collectors">
                                <i class="fas fa-list"></i>
                                <span class="menu-text">Ver Cobradores</span>
                            </a>
                            <a href="#" class="menu-link" data-page="add-collector">
                                <i class="fas fa-plus"></i>
                                <span class="menu-text">Agregar Cobrador</span>
                            </a>
                            <a href="#" class="menu-link" data-page="collector-map">
                                <i class="fas fa-map-marked-alt"></i>
                                <span class="menu-text">Ubicación en Vivo</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="menu-item">
                        <a href="#" class="menu-link" id="creditsMenuToggle">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span class="menu-text">Créditos</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="submenu" id="creditsSubmenu">
                            <a href="#" class="menu-link" data-page="credits">
                                <i class="fas fa-list"></i>
                                <span class="menu-text">Ver Créditos</span>
                            </a>
                            <a href="#" class="menu-link" data-page="overdue-clients">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span class="menu-text">Clientes en Mora</span>
                                <span class="menu-badge">5</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="menu-item">
                        <a href="#" class="menu-link" id="reportsMenuToggle">
                            <i class="fas fa-chart-bar"></i>
                            <span class="menu-text">Reportes</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="submenu" id="reportsSubmenu">
                            <a href="#" class="menu-link" data-page="daily-reports">
                                <i class="fas fa-calendar-day"></i>
                                <span class="menu-text">Reportes Diarios</span>
                            </a>
                            <a href="#" class="menu-link" data-page="period-reports">
                                <i class="fas fa-calendar-week"></i>
                                <span class="menu-text">Reportes por Período</span>
                            </a>
                            <a href="#" class="menu-link" data-page="collector-reports">
                                <i class="fas fa-user-chart"></i>
                                <span class="menu-text">Reportes por Cobrador</span>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Menú para cobrador -->
                <div id="collectorMenu" style="display: none;">
                    <div class="menu-item">
                        <a href="#" class="menu-link active" data-page="collector-dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span class="menu-text">Mi Dashboard</span>
                        </a>
                    </div>
                    
                    <div class="menu-item">
                        <a href="#" class="menu-link" id="clientsMenuToggle">
                            <i class="fas fa-users"></i>
                            <span class="menu-text">Clientes</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="submenu" id="clientsSubmenu">
                            <a href="#" class="menu-link" data-page="clients">
                                <i class="fas fa-list"></i>
                                <span class="menu-text">Ver Clientes</span>
                            </a>
                            <a href="#" class="menu-link" data-page="add-client">
                                <i class="fas fa-plus"></i>
                                <span class="menu-text">Agregar Cliente</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="menu-item">
                        <a href="#" class="menu-link" id="myCreditsMenuToggle">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span class="menu-text">Mis Créditos</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="submenu" id="myCreditsSubmenu">
                            <a href="#" class="menu-link" data-page="my-credits">
                                <i class="fas fa-list"></i>
                                <span class="menu-text">Ver Créditos</span>
                            </a>
                            <a href="#" class="menu-link" data-page="add-credit">
                                <i class="fas fa-plus"></i>
                                <span class="menu-text">Crear Crédito</span>
                            </a>
                            <a href="#" class="menu-link" data-page="daily-payments">
                                <i class="fas fa-calendar-day"></i>
                                <span class="menu-text">Cobros del Día</span>
                                <span class="menu-badge">8</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="menu-item">
                        <a href="#" class="menu-link" data-page="my-reports">
                            <i class="fas fa-chart-bar"></i>
                            <span class="menu-text">Mis Reportes</span>
                        </a>
                    </div>
                </div>
                
                <div class="menu-item">
                    <a href="#" class="menu-link" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="menu-text">Cerrar Sesión</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Contenido principal -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <div class="header">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <button class="notification-btn" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </button>
                </div>
            </div>
            
            <!-- Contenido de la página -->
            <div class="content">
                <!-- Dashboard Administrador -->
                <div class="page active" id="dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                            <div class="stat-info">
                                <h3>$45,230</h3>
                                <p>Total Créditos Activos</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h3>$2,840</h3>
                                <p>Total Cobrado Hoy</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon danger">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-info">
                                <h3>$5,120</h3>
                                <p>Total en Mora</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3>12</h3>
                                <p>Cobradores Activos</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Ingresos Diarios
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="incomeChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-map-marked-alt"></i>
                                Ubicación de Cobradores
                            </h2>
                            <button class="btn btn-primary btn-sm" id="viewFullMap">Ver Mapa Completo</button>
                        </div>
                        <div class="card-body">
                            <div class="map-container" id="collectorMap"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard Cobrador -->
                <div class="page" id="collector-dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                            <div class="stat-info">
                                <h3>$8,450</h3>
                                <p>Mis Créditos Activos</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h3>$560</h3>
                                <p>Cobrado Hoy</h3>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon danger">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-info">
                                <h3>$890</h3>
                                <p>Clientes en Mora</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3>24</h3>
                                <p>Mis Clientes</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-calendar-day"></i>
                                Cobros del Día
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="client-list" id="dailyPaymentsList">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Cobradores -->
                <div class="page" id="collectors">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-users"></i>
                                Gestión de Cobradores
                            </h2>
                            <button class="btn btn-primary btn-sm" id="addCollectorBtn">Agregar Cobrador</button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Email</th>
                                            <th>Teléfono</th>
                                            <th>Zona</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="collectorsTableBody">
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Clientes -->
                <div class="page" id="clients">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-users"></i>
                                Mis Clientes
                            </h2>
                            <button class="btn btn-primary btn-sm" id="addClientBtn">Agregar Cliente</button>
                        </div>
                        <div class="card-body">
                            <div class="client-list" id="clientsList">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Créditos -->
                <div class="page" id="credits">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-hand-holding-usd"></i>
                                Todos los Créditos
                            </h2>
                            <div class="btn-group">
                                <button class="btn btn-outline btn-sm">Exportar Excel</button>
                                <button class="btn btn-outline btn-sm">Exportar PDF</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Cliente</th>
                                            <th>Cobrador</th>
                                            <th>Monto</th>
                                            <th>Interés</th>
                                            <th>Total</th>
                                            <th>Plazo</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="creditsTableBody">
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Mis Créditos -->
                <div class="page" id="my-credits">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-hand-holding-usd"></i>
                                Mis Créditos
                            </h2>
                            <button class="btn btn-primary btn-sm" id="addCreditBtn">Crear Crédito</button>
                        </div>
                        <div class="card-body">
                            <div class="credit-list" id="myCreditsList">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Clientes en Mora -->
                <div class="page" id="overdue-clients">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Clientes en Mora
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="client-list" id="overdueClientsList">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Cobros del Día -->
                <div class="page" id="daily-payments">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-calendar-day"></i>
                                Cobros del Día
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="client-list" id="dailyPaymentsCollectorList">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Reportes Diarios -->
                <div class="page" id="daily-reports">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-calendar-day"></i>
                                Reportes Diarios
                            </h2>
                            <button class="btn btn-primary btn-sm" id="generateDailyReport">Generar Reporte</button>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reportDate">Fecha</label>
                                    <input type="date" id="reportDate" class="form-control">
                                </div>
                            </div>
                            
                            <div class="tabs">
                                <button class="tab active" data-tab="summary">Resumen</button>
                                <button class="tab" data-tab="details">Detalles</button>
                            </div>
                            
                            <div class="tab-content active" id="summary">
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-icon success">
                                            <i class="fas fa-dollar-sign"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>$2,840</h3>
                                            <p>Total Cobrado</p>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-icon primary">
                                            <i class="fas fa-hand-holding-usd"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>42</h3>
                                            <p>Cobros Realizados</p>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-icon danger">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3>8</h3>
                                            <p>Cobros Pendientes</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-content" id="details">
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>ID Crédito</th>
                                                <th>Cliente</th>
                                                <th>Cobrador</th>
                                                <th>Monto</th>
                                                <th>Estado</th>
                                                <th>Hora</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Se llenará dinámicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Reportes por Período -->
                <div class="page" id="period-reports">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-calendar-week"></i>
                                Reportes por Período
                            </h2>
                            <button class="btn btn-primary btn-sm" id="generatePeriodReport">Generar Reporte</button>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="startDate">Fecha Inicio</label>
                                    <input type="date" id="startDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="endDate">Fecha Fin</label>
                                    <input type="date" id="endDate" class="form-control">
                                </div>
                            </div>
                            
                            <div class="chart-container">
                                <canvas id="periodChart"></canvas>
                            </div>
                            
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Total Cobrado</th>
                                            <th>N° Cobros</th>
                                            <th>Nuevos Créditos</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Reportes por Cobrador -->
                <div class="page" id="collector-reports">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-user-chart"></i>
                                Reportes por Cobrador
                            </h2>
                            <button class="btn btn-primary btn-sm" id="generateCollectorReport">Generar Reporte</button>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="collectorSelect">Cobrador</label>
                                    <select id="collectorSelect" class="form-control">
                                        <option value="">Todos los cobradores</option>
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="reportMonth">Mes</label>
                                    <input type="month" id="reportMonth" class="form-control">
                                </div>
                            </div>
                            
                            <div class="chart-container">
                                <canvas id="collectorChart"></canvas>
                            </div>
                            
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Cobrador</th>
                                            <th>Total Cobrado</th>
                                            <th>N° Cobros</th>
                                            <th>Nuevos Créditos</th>
                                            <th>Clientes en Mora</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Mis Reportes -->
                <div class="page" id="my-reports">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                Mis Reportes
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="myReportMonth">Mes</label>
                                    <input type="month" id="myReportMonth" class="form-control">
                                </div>
                            </div>
                            
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon success">
                                        <i class="fas fa-dollar-sign"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h3>$12,450</h3>
                                        <p>Total Cobrado</p>
                                    </div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-icon primary">
                                        <i class="fas fa-hand-holding-usd"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h3>186</h3>
                                        <p>Cobros Realizados</p>
                                    </div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-icon warning">
                                        <i class="fas fa-percentage"></i>
                                    </div>
                                    <div class="stat-info">
                                        <h3>92%</h3>
                                        <p>Tasa de Cobro</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chart-container">
                                <canvas id="myReportChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Agregar Cobrador -->
                <div class="page" id="add-collector">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-user-plus"></i>
                                Agregar Cobrador
                            </h2>
                        </div>
                        <div class="card-body">
                            <form id="addCollectorForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="collectorName">Nombre Completo</label>
                                        <input type="text" id="collectorName" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="collectorEmail">Correo Electrónico</label>
                                        <input type="email" id="collectorEmail" class="form-control" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="collectorPhone">Teléfono</label>
                                        <input type="tel" id="collectorPhone" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="collectorZone">Zona/Ruta</label>
                                        <input type="text" id="collectorZone" class="form-control" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="collectorPassword">Contraseña</label>
                                    <input type="password" id="collectorPassword" class="form-control" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="collectorAddress">Dirección</label>
                                    <input type="text" id="collectorAddress" class="form-control">
                                </div>
                                
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary">Guardar</button>
                                    <button type="button" class="btn btn-outline" id="cancelAddCollector">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Agregar Cliente -->
                <div class="page" id="add-client">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-user-plus"></i>
                                Agregar Cliente
                            </h2>
                        </div>
                        <div class="card-body">
                            <form id="addClientForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="clientName">Nombre Completo</label>
                                        <input type="text" id="clientName" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="clientPhone">Teléfono</label>
                                        <input type="tel" id="clientPhone" class="form-control" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="clientAddress">Dirección</label>
                                    <input type="text" id="clientAddress" class="form-control" required>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="clientBusiness">Tipo de Negocio</label>
                                        <input type="text" id="clientBusiness" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="clientRoute">Ruta/Zona</label>
                                        <input type="text" id="clientRoute" class="form-control">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="clientReferences">Referencias</label>
                                    <textarea id="clientReferences" class="form-control" rows="3"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label>Ubicación GPS</label>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-outline" id="getCurrentLocation">
                                            <i class="fas fa-map-marker-alt"></i> Obtener Ubicación Actual
                                        </button>
                                    </div>
                                    <div id="locationInfo" style="margin-top: 10px; display: none;">
                                        <small>Latitud: <span id="latitude"></span>, Longitud: <span id="longitude"></span></small>
                                    </div>
                                </div>
                                
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary">Guardar</button>
                                    <button type="button" class="btn btn-outline" id="cancelAddClient">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Crear Crédito -->
                <div class="page" id="add-credit">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-plus-circle"></i>
                                Crear Crédito
                            </h2>
                        </div>
                        <div class="card-body">
                            <form id="addCreditForm">
                                <div class="form-group">
                                    <label for="creditClient">Cliente</label>
                                    <select id="creditClient" class="form-control" required>
                                        <option value="">Seleccionar cliente</option>
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="creditAmount">Monto Prestado ($)</label>
                                        <input type="number" id="creditAmount" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="creditInterest">Tasa de Interés (%)</label>
                                        <input type="number" id="creditInterest" class="form-control" value="20" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="creditTerm">Plazo (días)</label>
                                        <input type="number" id="creditTerm" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="paymentFrequency">Frecuencia de Pago</label>
                                        <select id="paymentFrequency" class="form-control" required>
                                            <option value="daily">Diario</option>
                                            <option value="weekly">Semanal</option>
                                            <option value="biweekly">Quincenal</option>
                                            <option value="monthly">Mensual</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="creditNotes">Notas</label>
                                    <textarea id="creditNotes" class="form-control" rows="3"></textarea>
                                </div>
                                
                                <div class="card" style="background: #f8f9fa; margin-top: 20px;">
                                    <div class="card-body">
                                        <h3>Resumen del Crédito</h3>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>Monto Total a Pagar:</label>
                                                <h4 id="totalAmount">$0</h4>
                                            </div>
                                            <div class="form-group">
                                                <label>Monto de Cuota:</label>
                                                <h4 id="paymentAmount">$0</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary">Crear Crédito</button>
                                    <button type="button" class="btn btn-outline" id="cancelAddCredit">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Página de Ubicación en Vivo -->
                <div class="page" id="collector-map">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-map-marked-alt"></i>
                                Ubicación en Vivo de Cobradores
                            </h2>
                            <button class="btn btn-primary btn-sm" id="refreshMap">Actualizar</button>
                        </div>
                        <div class="card-body">
                            <div class="map-container" id="liveCollectorMap"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navegación inferior para móviles -->
        <div class="bottom-nav">
            <div class="bottom-nav-items" id="bottomNavItems">
                <!-- Se llenará dinámicamente según el rol -->
            </div>
        </div>
        
        <!-- Botón flotante para acciones rápidas -->
        <button class="floating-btn" id="floatingBtn">
            <i class="fas fa-plus"></i>
        </button>
    </div>
    
    <!-- Modales -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Registrar Pago</h3>
                <button class="modal-close" id="closePaymentModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <div class="form-group">
                        <label for="paymentDate">Fecha de Pago</label>
                        <input type="date" id="paymentDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentAmount">Monto Pagado ($)</label>
                        <input type="number" id="paymentAmount" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentType">Tipo de Pago</label>
                        <select id="paymentType" class="form-control" required>
                            <option value="full">Pago Completo</option>
                            <option value="partial">Abono Parcial</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentNotes">Notas</label>
                        <textarea id="paymentNotes" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Registrar Pago</button>
                        <button type="button" class="btn btn-outline" id="cancelPayment">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal" id="renewalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Renovar Crédito</h3>
                <button class="modal-close" id="closeRenewalModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="renewalForm">
                    <div class="form-group">
                        <label for="renewalAmount">Nuevo Monto ($)</label>
                        <input type="number" id="renewalAmount" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="renewalInterest">Tasa de Interés (%)</label>
                            <input type="number" id="renewalInterest" class="form-control" value="20" required>
                        </div>
                        <div class="form-group">
                            <label for="renewalTerm">Nuevo Plazo (días)</label>
                            <input type="number" id="renewalTerm" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="renewalNotes">Notas de Renovación</label>
                        <textarea id="renewalNotes" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Renovar Crédito</button>
                        <button type="button" class="btn btn-outline" id="cancelRenewal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Contenedor de notificaciones -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBpWt0zx9nRWixhQVePA_sbAGEX32OsKBE",
            authDomain: "controlcobros-prod.firebaseapp.com",
            projectId: "controlcobros-prod",
            storageBucket: "controlcobros-prod.firebasestorage.app",
            messagingSenderId: "731341674636",
            appId: "1:731341674636:web:d00e3e5f715303617403a9"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 🔒 Desactivar la persistencia de la sesión: al cerrar la pestaña, se pierde la autenticación
        auth.setPersistence(firebase.auth.Auth.Persistence.NONE)
        .catch(function(error) {
            console.error("Error al establecer persistencia NONE:", error);
        });
        
        // Variables globales

        let incomeChart = null;
        let periodChart = null;
        let collectorChart = null;
        let myReportChart = null;
        let currentUser = null;
        let currentUserRole = null;
        let currentPage = 'dashboard';
        let map = null;
        let markers = [];
        
        // Datos simulados para demostración
        const simulatedData = {
            collectors: [
                {
                    id: 1,
                    name: "Juan Pérez",
                    email: "juan@ejemplo.com",
                    phone: "+1234567890",
                    zone: "Zona Norte",
                    status: "active",
                    location: { lat: 14.0723, lng: -87.1921 }
                },
                {
                    id: 2,
                    name: "María García",
                    email: "maria@ejemplo.com",
                    phone: "+1234567891",
                    zone: "Zona Centro",
                    status: "active",
                    location: { lat: 14.0623, lng: -87.1821 }
                },
                {
                    id: 3,
                    name: "Carlos López",
                    email: "carlos@ejemplo.com",
                    phone: "+1234567892",
                    zone: "Zona Sur",
                    status: "inactive",
                    location: { lat: 14.0823, lng: -87.1721 }
                }
            ],
            clients: [
                {
                    id: 1,
                    name: "Roberto Sánchez",
                    phone: "+1234567893",
                    address: "Calle Principal #123",
                    business: "Tienda de ropa",
                    route: "Ruta 1",
                    references: "Pedro Gómez (vecino) - +1234567894",
                    location: { lat: 14.0623, lng: -87.2021 },
                    collectorId: 1
                },
                {
                    id: 2,
                    name: "Ana Martínez",
                    phone: "+1234567895",
                    address: "Avenida Central #456",
                    business: "Pulpería",
                    route: "Ruta 2",
                    references: "Luis Fernández (cuñado) - +1234567896",
                    location: { lat: 14.0723, lng: -87.2121 },
                    collectorId: 1
                },
                {
                    id: 3,
                    name: "José Ramírez",
                    phone: "+1234567897",
                    address: "Colonia Bonita #789",
                    business: "Carnicería",
                    route: "Ruta 3",
                    references: "María López (esposa) - +1234567898",
                    location: { lat: 14.0823, lng: -87.1921 },
                    collectorId: 2
                }
            ],
            credits: [
                {
                    id: 1,
                    clientId: 1,
                    collectorId: 1,
                    amount: 1000,
                    interest: 20,
                    total: 1200,
                    term: 30,
                    paymentFrequency: "daily",
                    paymentAmount: 40,
                    startDate: "2023-01-01",
                    status: "active",
                    paymentsMade: 15,
                    paymentsPending: 15
                },
                {
                    id: 2,
                    clientId: 2,
                    collectorId: 1,
                    amount: 1500,
                    interest: 20,
                    total: 1800,
                    term: 45,
                    paymentFrequency: "daily",
                    paymentAmount: 40,
                    startDate: "2023-01-05",
                    status: "active",
                    paymentsMade: 20,
                    paymentsPending: 25
                },
                {
                    id: 3,
                    clientId: 3,
                    collectorId: 2,
                    amount: 800,
                    interest: 25,
                    total: 1000,
                    term: 20,
                    paymentFrequency: "daily",
                    paymentAmount: 50,
                    startDate: "2023-01-10",
                    status: "overdue",
                    paymentsMade: 5,
                    paymentsPending: 15
                }
            ],
            payments: [
                {
                    id: 1,
                    creditId: 1,
                    amount: 40,
                    date: "2023-01-15",
                    type: "full",
                    notes: "Pago recibido en tienda"
                },
                {
                    id: 2,
                    creditId: 2,
                    amount: 40,
                    date: "2023-01-15",
                    type: "full",
                    notes: "Pago recibido en domicilio"
                },
                {
                    id: 3,
                    creditId: 3,
                    amount: 25,
                    date: "2023-01-14",
                    type: "partial",
                    notes: "Abono parcial"
                }
            ]
        };
        
        // Inicialización de la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay un usuario autenticado
            auth.onAuthStateChanged(async function(user) {
                if (user) {
                    try {
                        // Verificar si existe el documento de usuario en Firestore
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            currentUser = {
                                uid: user.uid,
                                email: user.email,
                                displayName: user.email.split('@')[0]
                            };
                            currentUserRole = userDoc.data().role;
                            showApp();
                            initializeApp();
                        } else {
                            // No tiene rol asignado: cerrar sesión
                            await auth.signOut();
                            showNotification('warning', 'Sesión inválida', 'Tu cuenta no está configurada correctamente. Por favor, contacta al administrador.');
                            showAuth();
                        }
                    } catch (error) {
                        console.error("Error al verificar usuario:", error);
                        await auth.signOut();
                        showNotification('danger', 'Error', 'No se pudo verificar tu sesión. Intenta iniciar sesión nuevamente.');
                        showAuth();
                    }
                } else {
                    showAuth();
                }
            });
            
            // Event listeners para autenticación
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Event listeners para UI
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', toggleSidebar);

            // Event listeners para menús desplegables
            document.getElementById('collectorsMenuToggle')?.addEventListener('click', toggleSubmenu);
            document.getElementById('creditsMenuToggle')?.addEventListener('click', toggleSubmenu);
            document.getElementById('reportsMenuToggle')?.addEventListener('click', toggleSubmenu);
            document.getElementById('clientsMenuToggle')?.addEventListener('click', toggleSubmenu);
            document.getElementById('myCreditsMenuToggle')?.addEventListener('click', toggleSubmenu);
            
            // Event listeners para navegación
            document.querySelectorAll('.menu-link[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    navigateToPage(page);
                });
            });

            // Event listeners para actualizar mapa
            document.getElementById('refreshMap')?.addEventListener('click', async function() {
                await initializeMaps();
                showNotification('info', 'Mapa actualizado', 'La ubicación de los cobradores ha sido actualizada.');
            });

            // Event listeners para mapa completo
            document.getElementById('viewFullMap')?.addEventListener('click', function() {
                navigateToPage('collector-map');
            });
                        
            // Event listeners para tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
            
            // Event listeners para modales
            document.getElementById('closePaymentModal')?.addEventListener('click', function() {
                document.getElementById('paymentModal').classList.remove('open');
            });
            
            document.getElementById('closeRenewalModal')?.addEventListener('click', function() {
                document.getElementById('renewalModal').classList.remove('open');
            });
            
            // Event listeners para formularios
            document.getElementById('addCollectorForm')?.addEventListener('submit', handleAddCollector);
            document.getElementById('addClientForm')?.addEventListener('submit', handleAddClient);
            document.getElementById('addCreditForm')?.addEventListener('submit', handleAddCredit);
            document.getElementById('paymentForm')?.addEventListener('submit', handlePayment);
            document.getElementById('renewalForm')?.addEventListener('submit', handleRenewal);
            
            // Event listeners para botones
            document.getElementById('addCollectorBtn')?.addEventListener('click', function() {
                navigateToPage('add-collector');
            });
            
            document.getElementById('addClientBtn')?.addEventListener('click', function() {
                navigateToPage('add-client');
            });
            
            document.getElementById('addCreditBtn')?.addEventListener('click', function() {
                navigateToPage('add-credit');
            });
            
            document.getElementById('getCurrentLocation')?.addEventListener('click', getCurrentLocation);
            
            document.getElementById('creditAmount')?.addEventListener('input', calculateCreditSummary);
            document.getElementById('creditInterest')?.addEventListener('input', calculateCreditSummary);
            document.getElementById('creditTerm')?.addEventListener('input', calculateCreditSummary);
            document.getElementById('paymentFrequency')?.addEventListener('change', calculateCreditSummary);
            
            // Inicializar fecha actual en los formularios
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate')?.setAttribute('value', today);
            document.getElementById('reportDate')?.setAttribute('value', today);
            
            
        });
        
        // Funciones de autenticación
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    return db.collection('users').doc(userCredential.user.uid).get();
                })
                .then((doc) => {
                    if (doc.exists) {
                        currentUser = {
                            uid: doc.id,
                            email: doc.data().email,
                            displayName: doc.data().email.split('@')[0]
                        };
                        currentUserRole = doc.data().role;
                        showApp();
                        initializeApp();
                        showNotification('success', 'Inicio de sesión exitoso', 'Bienvenido a ControlCobros');
                    } else {
                        throw new Error('Usuario no tiene rol asignado. Contacte al administrador.');
                    }
                })
                .catch((error) => {
                    console.error("Error en login:", error);
                    showNotification('danger', 'Error de autenticación', error.message);
                });
        }
        
        function handleLogout() {
            auth.signOut().then(() => {
                currentUser = null;
                currentUserRole = null;
                showAuth();
                showNotification('info', 'Sesión cerrada', 'Has cerrado tu sesión correctamente');
            }).catch((error) => {
                showNotification('danger', 'Error', 'No se pudo cerrar la sesión');
            });
        }
        
        function showAuth() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }
        
        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
        }

        // === FUNCION PARA LLENAR EL SELECTOR DE CLIENTES EN CREAR CRÉDITO ===
        async function loadClientsIntoCreditSelector() {
            const creditClient = document.getElementById('creditClient');
            if (!creditClient) return;

            const uid = currentUser.uid;
            creditClient.innerHTML = '<option value="">Seleccionar cliente</option>';
            
            let clientsQuery = db.collection('clients');
            if (currentUserRole === 'collector') {
                clientsQuery = clientsQuery.where('collectorId', '==', uid);
            }
            
            const clientsSnap = await clientsQuery.get();
            if (clientsSnap.empty) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay clientes disponibles';
                option.disabled = true;
                creditClient.appendChild(option);
                return;
            }

            clientsSnap.forEach(doc => {
                const client = doc.data();
                if (client.name) {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = client.name;
                    creditClient.appendChild(option);
                }
            });
        }
        
        // Funciones de inicialización
        function initializeApp() {
            // Configurar información del usuario
            document.getElementById('userName').textContent = currentUser.displayName || 'Usuario';
            document.getElementById('userRole').textContent = currentUserRole === 'admin' ? 'Administrador' : 'Cobrador';
            document.getElementById('userAvatar').textContent = (currentUser.displayName || 'U').charAt(0).toUpperCase();
            
            // Configurar menú según rol
            if (currentUserRole === 'admin') {
                document.getElementById('adminMenu').style.display = 'block';
                document.getElementById('collectorMenu').style.display = 'none';
                
                // Configurar navegación inferior para administrador
                const bottomNavItems = document.getElementById('bottomNavItems');
                bottomNavItems.innerHTML = `
                    <a href="#" class="bottom-nav-item active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="bottom-nav-item" data-page="collectors">
                        <i class="fas fa-users"></i>
                        <span>Cobradores</span>
                    </a>
                    <a href="#" class="bottom-nav-item" data-page="credits">
                        <i class="fas fa-hand-holding-usd"></i>
                        <span>Créditos</span>
                    </a>
                    <a href="#" class="bottom-nav-item" data-page="overdue-clients">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Mora</span>
                    </a>
                `;
                
                // Cargar página de dashboard de administrador
                navigateToPage('dashboard');
            } else {
                document.getElementById('adminMenu').style.display = 'none';
                document.getElementById('collectorMenu').style.display = 'block';
                
                // Configurar navegación inferior para cobrador
                const bottomNavItems = document.getElementById('bottomNavItems');
                bottomNavItems.innerHTML = `
                    <a href="#" class="bottom-nav-item active" data-page="collector-dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="bottom-nav-item" data-page="clients">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                    <a href="#" class="bottom-nav-item" data-page="my-credits">
                        <i class="fas fa-hand-holding-usd"></i>
                        <span>Créditos</span>
                    </a>
                    <a href="#" class="bottom-nav-item" data-page="daily-payments">
                        <i class="fas fa-calendar-day"></i>
                        <span>Cobros</span>
                    </a>
                `;
                
                // Cargar página de dashboard de cobrador
                navigateToPage('collector-dashboard');
            }
            
            // Configurar eventos para navegación inferior
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    navigateToPage(page);
                });
            });
            
            // Configurar botón flotante
            const floatingBtn = document.getElementById('floatingBtn');
            if (currentUserRole === 'collector') {
                floatingBtn.style.display = 'flex';
                floatingBtn.addEventListener('click', function() {
                    navigateToPage('add-credit');
                });
            } else {
                floatingBtn.style.display = 'none';
            }
            
            // Cargar datos reales
            loadRealData();
        }


        async function toggleCollectorStatus(collectorId, currentStatus) {
            if (!confirm(`¿Está seguro de que desea ${currentStatus === 'active' ? 'desactivar' : 'activar'} este cobrador?`)) {
                return;
            }

            try {
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                await db.collection('collectors').doc(collectorId).update({
                    status: newStatus
                });
                showNotification('success', 'Estado actualizado', `El cobrador ha sido ${newStatus === 'active' ? 'activado' : 'desactivado'}.`);
                loadRealData(); // Recargar lista y mapa
            } catch (error) {
                console.error("Error al cambiar estado:", error);
                showNotification('danger', 'Error', 'No se pudo actualizar el estado del cobrador.');
            }
        }
        
        async function loadRealData() {
            const uid = currentUser.uid;

            try {
                // === Cargar cobradores (solo para admin) ===
                if (currentUserRole === 'admin' && document.getElementById('collectorsTableBody')) {
                    const collectorsTableBody = document.getElementById('collectorsTableBody');
                    collectorsTableBody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div></td></tr>';

                    const collectorsSnapshot = await db.collection('collectors').get();
                    collectorsTableBody.innerHTML = '';

                    collectorsSnapshot.forEach(doc => {
                        const collector = doc.data();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${collector.name || 'N/A'}</td>
                            <td>${collector.email || 'N/A'}</td>
                            <td>${collector.phone || 'N/A'}</td>
                            <td>${collector.zone || 'N/A'}</td>
                            <td><span class="status-badge ${collector.status}">${collector.status === 'active' ? 'Activo' : 'Inactivo'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editCollector('${doc.id}')">Editar</button>
                                <button class="btn btn-sm btn-danger" onclick="toggleCollectorStatus('${doc.id}', '${collector.status}')">
                                    ${collector.status === 'active' ? 'Desactivar' : 'Activar'}
                                </button>
                            </td>
                        `;
                        collectorsTableBody.appendChild(row);
                    });
                }

                // === Cargar clientes (solo para cobrador o admin) ===
                if ((currentUserRole === 'collector' || currentUserRole === 'admin') && document.getElementById('clientsList')) {
                    const clientsList = document.getElementById('clientsList');
                    clientsList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                    // Filtrar por collectorId si es cobrador
                    let clientsQuery = db.collection('clients');
                    if (currentUserRole === 'collector') {
                        clientsQuery = clientsQuery.where('collectorId', '==', uid);
                    }
                    const clientsSnapshot = await clientsQuery.get();
                    clientsList.innerHTML = '';

                    if (clientsSnapshot.empty) {
                        clientsList.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><h3>No hay clientes</h3><p>Aún no has agregado clientes.</p></div>';
                        return;
                    }

                    clientsSnapshot.forEach(doc => {
                        const client = doc.data();
                        const lat = client.location?.latitude || 14.07;
                        const lng = client.location?.longitude || -87.19;

                        const clientCard = document.createElement('div');
                        clientCard.className = 'client-card';
                        clientCard.innerHTML = `
                            <div class="client-header">
                                <div class="client-name">${client.name || 'N/A'}</div>
                                <span class="status-badge active">Activo</span>
                            </div>
                            <div class="client-details">
                                <div class="client-detail">
                                    <i class="fas fa-phone"></i>
                                    <span>${client.phone || 'N/A'}</span>
                                </div>
                                <div class="client-detail">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${client.address || 'N/A'}</span>
                                </div>
                                <div class="client-detail">
                                    <i class="fas fa-store"></i>
                                    <span>${client.business || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="client-actions">
                                <button class="btn btn-sm btn-primary whatsapp-btn" onclick="openWhatsApp('${client.phone || ''}')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="btn btn-sm btn-success location-btn" onclick="viewLocation(${lat}, ${lng})">
                                    <i class="fas fa-map-marker-alt"></i> Ubicación
                                </button>
                            </div>
                        `;
                        clientsList.appendChild(clientCard);
                    });
                }

                // === Cargar créditos (solo para admin) ===
                if (currentUserRole === 'admin' && document.getElementById('creditsTableBody')) {
                    const creditsTableBody = document.getElementById('creditsTableBody');
                    creditsTableBody.innerHTML = '<tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr>';

                    const creditsSnapshot = await db.collection('credits').get();
                    const clientsMap = new Map();
                    const collectorsMap = new Map();

                    // Cargar clientes y cobradores para mostrar nombres
                    const clientsSnapshot = await db.collection('clients').where('collectorId', '==', uid).get();
                    clientsSnapshot.forEach(doc => clientsMap.set(doc.id, doc.data().name || 'N/A'));

                    const collectorsSnapshot2 = await db.collection('collectors').get();
                    collectorsSnapshot2.forEach(doc => collectorsMap.set(doc.id, doc.data().name || 'N/A'));

                    creditsTableBody.innerHTML = '';
                    creditsSnapshot.forEach(doc => {
                        const credit = doc.data();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>#${doc.id.substring(0,8)}</td>
                            <td>${clientsMap.get(credit.clientId) || 'N/A'}</td>
                            <td>${collectorsMap.get(credit.collectorId) || 'N/A'}</td>
                            <td>$${credit.amount || 0}</td>
                            <td>${credit.interest || 0}%</td>
                            <td>$${credit.total || 0}</td>
                            <td>${credit.term || 0} días</td>
                            <td><span class="status-badge ${credit.status}">${getStatusText(credit.status)}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewCreditDetails('${doc.id}')">Ver Detalles</button>
                            </td>
                        `;
                        creditsTableBody.appendChild(row);
                    });
                }

                // === Cargar mis créditos (solo para cobrador) ===
                if (currentUserRole === 'collector' && document.getElementById('myCreditsList')) {
                    const myCreditsList = document.getElementById('myCreditsList');
                    myCreditsList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                    const creditsSnapshot = await db.collection('credits').where('collectorId', '==', uid).get();
                    const clientsMap = new Map();
                    const clientsSnapshot = await db.collection('clients').where('collectorId', '==', uid).get();
                    clientsSnapshot.forEach(doc => clientsMap.set(doc.id, doc.data()));

                    myCreditsList.innerHTML = '';
                    if (creditsSnapshot.empty) {
                        myCreditsList.innerHTML = '<div class="empty-state"><i class="fas fa-hand-holding-usd"></i><h3>No hay créditos</h3><p>Aún no has creado créditos.</p></div>';
                        return;
                    }

                    creditsSnapshot.forEach(doc => {
                        const credit = doc.data();
                        const client = clientsMap.get(credit.clientId) || {};
                        const lat = client.location?.latitude || 14.07;
                        const lng = client.location?.longitude || -87.19;
                        const totalPayments = (credit.paymentsMade || 0) + (credit.paymentsPending || 0);
                        const progressPercentage = totalPayments > 0 ? ((credit.paymentsMade || 0) / totalPayments) * 100 : 0;

                        const creditCard = document.createElement('div');
                        creditCard.className = 'credit-card';
                        creditCard.innerHTML = `
                            <div class="credit-header">
                                <div class="credit-amount">$${credit.total || 0}</div>
                                <span class="status-badge ${credit.status}">${getStatusText(credit.status)}</span>
                            </div>
                            <div class="credit-details">
                                <div class="credit-detail">
                                    <div class="credit-detail-label">Cliente</div>
                                    <div class="credit-detail-value">${client.name || 'N/A'}</div>
                                </div>
                                <div class="credit-detail">
                                    <div class="credit-detail-label">Cuota</div>
                                    <div class="credit-detail-value">$${credit.paymentAmount || 0}</div>
                                </div>
                                <div class="credit-detail">
                                    <div class="credit-detail-label">Pagos</div>
                                    <div class="credit-detail-value">${credit.paymentsMade || 0}/${totalPayments}</div>
                                </div>
                            </div>
                            <div class="payment-progress">
                                <div class="payment-progress-bar" style="width: ${progressPercentage}%"></div>
                            </div>
                            <div class="payment-actions">
                                <button class="btn btn-sm btn-primary" onclick="openPaymentModal('${doc.id}')">Registrar Pago</button>
                                <button class="btn btn-sm btn-warning" onclick="openRenewalModal('${doc.id}')">Renovar</button>
                                <button class="btn btn-sm whatsapp-btn" onclick="openWhatsApp('${client.phone || ''}')">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            </div>
                        `;
                        myCreditsList.appendChild(creditCard);
                    });
                }

                // === Clientes en mora (admin o cobrador) ===
                if ((currentUserRole === 'admin' || currentUserRole === 'collector') && document.getElementById('overdueClientsList')) {
                    const overdueClientsList = document.getElementById('overdueClientsList');
                    overdueClientsList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                    let query = db.collection('credits').where('status', '==', 'overdue');
                    if (currentUserRole === 'collector') {
                        query = query.where('collectorId', '==', uid);
                    }
                    const overdueSnapshot = await query.get();
                    const clientsMap = new Map();
                    const collectorsMap = new Map();

                    const clientsSnap = await db.collection('clients').get();
                    clientsSnap.forEach(doc => clientsMap.set(doc.id, doc.data()));

                    if (currentUserRole === 'admin') {
                        const collSnap = await db.collection('collectors').get();
                        collSnap.forEach(doc => collectorsMap.set(doc.id, doc.data().name || 'N/A'));
                    }

                    overdueClientsList.innerHTML = '';
                    if (overdueSnapshot.empty) {
                        overdueClientsList.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>No hay morosos</h3><p>Todos los créditos están al día.</p></div>';
                        return;
                    }

                    overdueSnapshot.forEach(doc => {
                        const credit = doc.data();
                        const client = clientsMap.get(credit.clientId) || {};
                        const collectorName = currentUserRole === 'admin' ? (collectorsMap.get(credit.collectorId) || 'N/A') : '';
                        const lat = client.location?.latitude || 14.07;
                        const lng = client.location?.longitude || -87.19;

                        const clientCard = document.createElement('div');
                        clientCard.className = 'client-card';
                        clientCard.innerHTML = `
                            <div class="client-header">
                                <div class="client-name">${client.name || 'N/A'}</div>
                                <span class="status-badge overdue">En Mora</span>
                            </div>
                            <div class="client-details">
                                <div class="client-detail">
                                    <i class="fas fa-phone"></i>
                                    <span>${client.phone || 'N/A'}</span>
                                </div>
                                <div class="client-detail">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${client.address || 'N/A'}</span>
                                </div>
                                ${currentUserRole === 'admin' ? `<div class="client-detail"><i class="fas fa-user"></i><span>Cobrador: ${collectorName}</span></div>` : ''}
                            </div>
                            <div class="client-details">
                                <div class="client-detail">
                                    <i class="fas fa-dollar-sign"></i>
                                    <span>Crédito: $${credit.total || 0}</span>
                                </div>
                                <div class="client-detail">
                                    <i class="fas fa-calendar-times"></i>
                                    <span>Pagos pendientes: ${credit.paymentsPending || 0}</span>
                                </div>
                            </div>
                            <div class="client-actions">
                                <button class="btn btn-sm btn-primary whatsapp-btn" onclick="openWhatsApp('${client.phone || ''}')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                <button class="btn btn-sm btn-success location-btn" onclick="viewLocation(${lat}, ${lng})">
                                    <i class="fas fa-map-marker-alt"></i> Ubicación
                                </button>
                            </div>
                        `;
                        overdueClientsList.appendChild(clientCard);
                    });
                }

                // === Llenar selectores iniciales ===
                loadClientsIntoCreditSelector();

                // === Inicializar gráficos y mapas ===
                initializeCharts();
                initializeMaps();

            } catch (error) {
                console.error("Error al cargar datos reales:", error);
                showNotification('danger', 'Error', 'No se pudieron cargar los datos. Intente nuevamente.');
            }
        }
        
        function initializeCharts() {
            // Destruir gráfico existente si ya existe
            if (incomeChart) {
                incomeChart.destroy();
            }
            if (document.getElementById('incomeChart')) {
                const ctx = document.getElementById('incomeChart').getContext('2d');
                incomeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                        datasets: [{
                            label: 'Ingresos',
                            data: [2100, 2400, 1800, 2900, 3200, 2800, 2400],
                            backgroundColor: 'rgba(26, 115, 232, 0.1)',
                            borderColor: '#1a73e8',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: v => '$' + v }
                            }
                        }
                    }
                });
            }

            // === Period Chart ===
            if (periodChart) periodChart.destroy();
            if (document.getElementById('periodChart')) {
                const ctx = document.getElementById('periodChart').getContext('2d');
                periodChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Ingresos',
                            data: [42000, 48000, 51000, 46000, 52000, 58000],
                            backgroundColor: 'rgba(26, 115, 232, 0.7)',
                            borderColor: '#1a73e8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: v => '$' + v }
                            }
                        }
                    }
                });
            }

            // === Collector Chart ===
            if (collectorChart) collectorChart.destroy();
            if (document.getElementById('collectorChart')) {
                const ctx = document.getElementById('collectorChart').getContext('2d');
                collectorChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Juan Pérez', 'María García', 'Carlos López', 'Otros'],
                        datasets: [{
                            data: [30, 25, 20, 25],
                            backgroundColor: ['#1a73e8', '#34a853', '#fbbc05', '#ea4335'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            // === My Report Chart ===
            if (myReportChart) myReportChart.destroy();
            if (document.getElementById('myReportChart')) {
                const ctx = document.getElementById('myReportChart').getContext('2d');
                myReportChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                        datasets: [{
                            label: 'Cobros',
                            data: [2800, 3200, 3100, 3350],
                            backgroundColor: 'rgba(52, 168, 83, 0.1)',
                            borderColor: '#34a853',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: v => '$' + v }
                            }
                        }
                    }
                });
            }
        }
        
        async function initializeMaps() {
            // Mapa de dashboard de administrador
            if (document.getElementById('collectorMap')) {
                if (map) map.remove(); // Limpiar mapa anterior
                map = L.map('collectorMap').setView([14.0723, -87.1921], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Cargar cobradores activos desde Firestore
                const collectorsSnapshot = await db.collection('collectors').where('status', '==', 'active').get();
                collectorsSnapshot.forEach(doc => {
                    const collector = doc.data();
                    if (collector.location) {
                        const marker = L.marker([collector.location.latitude, collector.location.longitude]).addTo(map);
                        marker.bindPopup(`<b>${collector.name}</b><br>Zona: ${collector.zone}<br>Email: ${collector.email}`);
                    }
                });
            }

            // Mapa de ubicación en vivo
            if (document.getElementById('liveCollectorMap')) {
                const liveMap = L.map('liveCollectorMap').setView([14.0723, -87.1921], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(liveMap);

                const collectorsSnapshot = await db.collection('collectors').get();
                collectorsSnapshot.forEach(doc => {
                    const collector = doc.data();
                    if (collector.location) {
                        const color = collector.status === 'active' ? 'green' : 'red';
                        const marker = L.marker([collector.location.latitude, collector.location.longitude], {
                            icon: L.divIcon({
                                html: `<div style="background-color:${color}; width:20px; height:20px; border-radius:50%; border:2px solid white;"></div>`,
                                className: '',
                                iconSize: [20, 20]
                            })
                        }).addTo(liveMap);
                        marker.bindPopup(`<b>${collector.name}</b><br>Estado: ${collector.status === 'active' ? 'Activo' : 'Inactivo'}`);
                    }
                });
            }
        }
        
        // Funciones de navegación
        function navigateToPage(pageId) {
            // Ocultar todas las páginas
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Mostrar la página seleccionada
            document.getElementById(pageId).classList.add('active');
            
            // Actualizar título de la página
            const pageTitle = document.getElementById('pageTitle');
            switch (pageId) {
                case 'dashboard':
                    pageTitle.textContent = 'Dashboard';
                    break;
                case 'collector-dashboard':
                    pageTitle.textContent = 'Mi Dashboard';
                    break;
                case 'collectors':
                    pageTitle.textContent = 'Cobradores';
                    break;
                case 'clients':
                    pageTitle.textContent = 'Clientes';
                    break;
                case 'credits':
                    pageTitle.textContent = 'Créditos';
                    break;
                case 'my-credits':
                    pageTitle.textContent = 'Mis Créditos';
                    break;
                case 'overdue-clients':
                    pageTitle.textContent = 'Clientes en Mora';
                    break;
                case 'daily-payments':
                    pageTitle.textContent = 'Cobros del Día';
                    break;
                case 'daily-reports':
                    pageTitle.textContent = 'Reportes Diarios';
                    break;
                case 'period-reports':
                    pageTitle.textContent = 'Reportes por Período';
                    break;
                case 'collector-reports':
                    pageTitle.textContent = 'Reportes por Cobrador';
                    break;
                case 'my-reports':
                    pageTitle.textContent = 'Mis Reportes';
                    break;
                case 'add-collector':
                    pageTitle.textContent = 'Agregar Cobrador';
                    break;
                case 'add-client':
                    pageTitle.textContent = 'Agregar Cliente';
                    break;
                case 'add-credit':
                    pageTitle.textContent = 'Crear Crédito';
                    break;
                case 'collector-map':
                    pageTitle.textContent = 'Ubicación en Vivo';
                    break;
                default:
                    pageTitle.textContent = 'ControlCobros';
            }
            
            // Actualizar navegación activa
            document.querySelectorAll('.menu-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.querySelectorAll(`.menu-link[data-page="${pageId}"]`).forEach(link => {
                link.classList.add('active');
            });
            
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelectorAll(`.bottom-nav-item[data-page="${pageId}"]`).forEach(item => {
                item.classList.add('active');
            });
            
            // Cerrar sidebar en móviles
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('mainContent').classList.remove('sidebar-open');
            }
            // Recargar clientes en el selector si se abre "Crear Crédito"
            if (pageId === 'add-credit') {
                loadClientsIntoCreditSelector();
            }
            // Actualizar página actual
            currentPage = pageId;
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('open');
            mainContent.classList.toggle('sidebar-open');
        }
        
        function toggleSubmenu(e) {
            e.preventDefault();
            const submenuId = this.id.replace('MenuToggle', 'Submenu');
            const submenu = document.getElementById(submenuId);
            
            if (submenu) {
                submenu.classList.toggle('open');
            }
        }
        
        function showTab(tabId) {
            // Ocultar todos los contenidos de tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Mostrar el contenido del tab seleccionado
            document.getElementById(tabId).classList.add('active');
            
            // Actualizar tabs activos
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll(`.tab[data-tab="${tabId}"]`).forEach(tab => {
                tab.classList.add('active');
            });
        }
        
        // Funciones de formularios
        async function handleAddCollector(e) {
            e.preventDefault();
            
            // Verificación adicional de que es el admin principal
            if (currentUser.email !== 'admin@control.com') {
                showNotification('danger', 'Acceso denegado', 'Solo el administrador principal puede crear cobradores.');
                return;
            }

            const name = document.getElementById('collectorName').value;
            const email = document.getElementById('collectorEmail').value;
            const phone = document.getElementById('collectorPhone').value;
            const zone = document.getElementById('collectorZone').value;
            const password = document.getElementById('collectorPassword').value;
            const address = document.getElementById('collectorAddress').value;

            if (!name || !email || !phone || !zone || !password) {
                showNotification('warning', 'Campos incompletos', 'Por favor completa todos los campos obligatorios.');
                return;
            }

            try {
                // Paso 1: Crear usuario en Firebase Authentication
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;

                // Paso 2: Guardar rol en /users/{uid}
                await db.collection('users').doc(uid).set({
                    email: email,
                    role: 'collector',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Paso 3: Guardar datos del cobrador en /collectors
                await db.collection('collectors').add({
                    userId: uid,
                    name: name,
                    email: email,
                    phone: phone,
                    zone: zone,
                    address: address,
                    status: 'active',
                    location: new firebase.firestore.GeoPoint(14.0723, -87.1921), // valor por defecto; se puede actualizar después
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('success', 'Cobrador creado', `${name} ha sido creado exitosamente. Se ha enviado un correo con sus credenciales.`);
                navigateToPage('collectors');
                document.getElementById('addCollectorForm').reset();
                loadRealData(); // Recargar la lista de cobradores

            } catch (error) {
                console.error("Error al crear cobrador:", error);
                let message = 'No se pudo crear el cobrador. Intente nuevamente.';
                if (error.code === 'auth/email-already-in-use') {
                    message = 'El correo ya está registrado en el sistema.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'El correo electrónico no es válido.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'La contraseña debe tener al menos 6 caracteres.';
                }
                showNotification('danger', 'Error', message);
            }
        }
        
        async function handleAddClient(e) {
            e.preventDefault();
            const name = document.getElementById('clientName').value;
            const phone = document.getElementById('clientPhone').value;
            const address = document.getElementById('clientAddress').value;
            const business = document.getElementById('clientBusiness').value;
            const route = document.getElementById('clientRoute').value;
            const references = document.getElementById('clientReferences').value;
            const latitude = parseFloat(document.getElementById('latitude').textContent);
            const longitude = parseFloat(document.getElementById('longitude').textContent);

            if (isNaN(latitude) || isNaN(longitude)) {
                showNotification('danger', 'Error', 'Debes obtener la ubicación GPS antes de guardar.');
                return;
            }

            try {
                await db.collection('clients').add({
                    collectorId: currentUser.uid,
                    name: name,
                    phone: phone,
                    address: address,
                    business: business,
                    route: route,
                    references: references,
                    location: new firebase.firestore.GeoPoint(latitude, longitude),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showNotification('success', 'Cliente agregado', `${name} ha sido agregado exitosamente`);
                navigateToPage('clients');
                document.getElementById('addClientForm').reset();
                document.getElementById('locationInfo').style.display = 'none';
                loadRealData(); // Recargar la lista
            } catch (error) {
                console.error("Error al guardar cliente:", error);
                showNotification('danger', 'Error', 'No se pudo guardar el cliente. Intente nuevamente.');
            }
        }
        
        async function handleAddCredit(e) {
            e.preventDefault();
            const clientId = document.getElementById('creditClient').value;
            const amount = parseFloat(document.getElementById('creditAmount').value);
            const interest = parseFloat(document.getElementById('creditInterest').value);
            const term = parseInt(document.getElementById('creditTerm').value);
            const paymentFrequency = document.getElementById('paymentFrequency').value;
            const notes = document.getElementById('creditNotes').value;

            if (!clientId) {
                showNotification('warning', 'Advertencia', 'Debe seleccionar un cliente.');
                return;
            }

            const total = amount * (1 + interest / 100);
            let paymentAmount;
            switch (paymentFrequency) {
                case 'daily':
                    paymentAmount = total / term;
                    break;
                case 'weekly':
                    paymentAmount = total / (term / 7);
                    break;
                case 'biweekly':
                    paymentAmount = total / (term / 15);
                    break;
                case 'monthly':
                    paymentAmount = total / (term / 30);
                    break;
                default:
                    paymentAmount = total / term;
            }

            try {
                await db.collection('credits').add({
                    clientId: clientId,
                    collectorId: currentUser.uid,
                    amount: amount,
                    interest: interest,
                    total: total,
                    term: term,
                    paymentFrequency: paymentFrequency,
                    paymentAmount: paymentAmount,
                    startDate: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active',
                    paymentsMade: 0,
                    paymentsPending: term,
                    notes: notes,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showNotification('success', 'Crédito creado', 'El crédito ha sido creado exitosamente');
                navigateToPage('my-credits');
                document.getElementById('addCreditForm').reset();
                document.getElementById('totalAmount').textContent = '$0';
                document.getElementById('paymentAmount').textContent = '$0';
                loadRealData(); // Recargar la lista
            } catch (error) {
                console.error("Error al crear crédito:", error);
                showNotification('danger', 'Error', 'No se pudo crear el crédito. Intente nuevamente.');
            }
        }
        
        async function handlePayment(e) {
            e.preventDefault();
            const creditId = currentCreditId; // Necesitamos saber a qué crédito pertenece el pago
            const date = document.getElementById('paymentDate').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const type = document.getElementById('paymentType').value;
            const notes = document.getElementById('paymentNotes').value;

            if (!creditId) {
                showNotification('danger', 'Error', 'No se ha seleccionado un crédito.');
                return;
            }

            try {
                // 1. Registrar el pago en la colección 'payments'
                await db.collection('payments').add({
                    creditId: creditId,
                    amount: amount,
                    date: firebase.firestore.Timestamp.fromDate(new Date(date)),
                    type: type,
                    notes: notes,
                    collectorId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Actualizar el crédito: incrementar paymentsMade y ajustar estado si es necesario
                const creditRef = db.collection('credits').doc(creditId);
                const creditDoc = await creditRef.get();
                if (!creditDoc.exists) throw new Error('Crédito no encontrado');

                const credit = creditDoc.data();
                const newPaymentsMade = (credit.paymentsMade || 0) + 1;
                const totalPayments = (credit.paymentsMade || 0) + (credit.paymentsPending || 0);
                let newStatus = credit.status;

                // Si ya se hicieron todos los pagos, marcar como pagado
                if (newPaymentsMade >= totalPayments) {
                    newStatus = 'paid';
                }

                await creditRef.update({
                    paymentsMade: newPaymentsMade,
                    status: newStatus
                });

                showNotification('success', 'Pago registrado', 'El pago ha sido registrado exitosamente');
                document.getElementById('paymentModal').classList.remove('open');
                document.getElementById('paymentForm').reset();
                loadRealData(); // Recargar todos los datos

            } catch (error) {
                console.error("Error al registrar pago:", error);
                showNotification('danger', 'Error', 'No se pudo registrar el pago. Intente nuevamente.');
            }
        }
        
        function handleRenewal(e) {
            e.preventDefault();
            
            const amount = document.getElementById('renewalAmount').value;
            const interest = document.getElementById('renewalInterest').value;
            const term = document.getElementById('renewalTerm').value;
            const notes = document.getElementById('renewalNotes').value;
            
            // Simulación de guardado
            setTimeout(() => {
                showNotification('success', 'Crédito renovado', 'El crédito ha sido renovado exitosamente');
                document.getElementById('renewalModal').classList.remove('open');
                
                // Limpiar formulario
                document.getElementById('renewalForm').reset();
                
                // Recargar página actual
                loadSimulatedData();
            }, 1000);
        }
        
        // Funciones de utilidad
        function calculateCreditSummary() {
            const amount = parseFloat(document.getElementById('creditAmount').value) || 0;
            const interest = parseFloat(document.getElementById('creditInterest').value) || 0;
            const term = parseInt(document.getElementById('creditTerm').value) || 0;
            const paymentFrequency = document.getElementById('paymentFrequency').value;
            
            // Calcular monto total
            const totalAmount = amount * (1 + interest / 100);
            
            // Calcular monto de cuota según frecuencia
            let paymentAmount;
            switch (paymentFrequency) {
                case 'daily':
                    paymentAmount = totalAmount / term;
                    break;
                case 'weekly':
                    paymentAmount = totalAmount / (term / 7);
                    break;
                case 'biweekly':
                    paymentAmount = totalAmount / (term / 15);
                    break;
                case 'monthly':
                    paymentAmount = totalAmount / (term / 30);
                    break;
                default:
                    paymentAmount = totalAmount / term;
            }
            
            // Actualizar UI
            document.getElementById('totalAmount').textContent = '$' + totalAmount.toFixed(2);
            document.getElementById('paymentAmount').textContent = '$' + paymentAmount.toFixed(2);
        }
        
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        
                        document.getElementById('latitude').textContent = latitude.toFixed(6);
                        document.getElementById('longitude').textContent = longitude.toFixed(6);
                        document.getElementById('locationInfo').style.display = 'block';
                        
                        showNotification('success', 'Ubicación obtenida', 'Se ha obtenido tu ubicación actual');
                    },
                    error => {
                        showNotification('danger', 'Error', 'No se pudo obtener tu ubicación');
                    }
                );
            } else {
                showNotification('danger', 'Error', 'Tu navegador no soporta geolocalización');
            }
        }
        
        let currentCreditId = null;

        function openPaymentModal(creditId) {
            currentCreditId = creditId;
            document.getElementById('paymentModal').classList.add('open');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
        }
        
        function openRenewalModal(creditId) {
            currentCreditId = creditId;
            document.getElementById('renewalModal').classList.add('open');
        }
        
        function openWhatsApp(phoneNumber) {
            if (phoneNumber) {
                const url = `https://wa.me/${phoneNumber.replace(/\D/g, '')}`;
                window.open(url, '_blank');
            } else {
                showNotification('warning', 'Número no disponible', 'Este cliente no tiene un número de teléfono registrado');
            }
        }
        
        function viewLocation(lat, lng) {
            const url = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}&zoom=16`;
            window.open(url, '_blank');
        }
        
        function getStatusText(status) {
            switch (status) {
                case 'active':
                    return 'Activo';
                case 'inactive':
                    return 'Inactivo';
                case 'pending':
                    return 'Pendiente';
                case 'overdue':
                    return 'En Mora';
                case 'paid':
                    return 'Pagado';
                default:
                    return status;
            }
        }
        
        function showNotification(type, title, message) {
            const notificationContainer = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let iconClass;
            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    break;
                case 'danger':
                    iconClass = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle';
                    break;
                case 'info':
                default:
                    iconClass = 'fas fa-info-circle';
                    break;
            }
            
            notification.innerHTML = `
                <div class="notification-icon ${type}">
                    <i class="${iconClass}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Mostrar notificación
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Cerrar notificación automáticamente
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
            
            // Cerrar notificación al hacer clic en el botón
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            });
        }
    </script>
</body>
</html>